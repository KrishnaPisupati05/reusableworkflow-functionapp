name: Reusable Build & Deploy Function App (Node.js + Slots via CLI)

on:
  workflow_call:
    inputs:
      function-app-name:
        required: true
        type: string
      resource-group:
        required: true
        type: string
      slot-name:
        required: true
        type: string
      functions-folder:
        required: true
        type: string
      node-version:
        required: false
        type: string
        default: '20'
      swap-after-deploy:
        required: false
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Install dependencies & package
        working-directory: ${{ inputs.functions-folder }}
        run: |
          npm ci --production
          zip -r ../functionapp.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: functionapp-zip
          path: functionapp.zip

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: functionapp-zip

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Slot if not exists
        id: create-slot
        continue-on-error: true
        run: |
          echo "Checking if slot exists..."
          SLOT_EXISTS=$(az functionapp deployment slot list \
            --name ${{ inputs.function-app-name }} \
            --resource-group ${{ inputs.resource-group }} \
            --query "[?name=='${{ inputs.slot-name }}'] | length(@)" -o tsv)

          if [ "$SLOT_EXISTS" -eq 0 ]; then
            echo "Creating slot: ${{ inputs.slot-name }}"
            az functionapp deployment slot create \
              --name ${{ inputs.function-app-name }} \
              --resource-group ${{ inputs.resource-group }} \
              --slot ${{ inputs.slot-name }} \
              --configuration-source ${{ inputs.function-app-name }}
          else
            echo "Slot ${{ inputs.slot-name }} already exists."
          fi

      - name: Deploy Function App Code (ZIP Deploy)
        run: |
          az functionapp deployment source config-zip \
            --resource-group ${{ inputs.resource-group }} \
            --name ${{ inputs.function-app-name }} \
            --slot ${{ inputs.slot-name }} \
            --src functionapp.zip

      - name: Optional Slot Swap (Staging â†’ Production)
        if: ${{ inputs.swap-after-deploy == true }}
        run: |
          echo "Swapping slot '${{ inputs.slot-name }}' with production..."
          az functionapp deployment slot swap \
            --resource-group ${{ inputs.resource-group }} \
            --name ${{ inputs.function-app-name }} \
            --slot ${{ inputs.slot-name }}
