name: Reusable Function App Deploy 

on:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version."
        required: false
        type: string
        default: "20.x"
      working_directory:
        description: "Working directory containing the Function App project."
        required: false
        type: string
        default: "."
      test_function_app_name:
        description: "Azure Function App name for TEST deployments."
        required: false
        type: string
      prod_function_app_name:
        description: "Azure Function App name for PROD deployments."
        required: false
        type: string
      deploy_to_prod:
        description: "Deploy-->Production  Set to True"
        required: false
        type: string
    secrets:
      PUBLISH_PROFILE_TEST:
        required: false
      PUBLISH_PROFILE_PROD:
        required: false

jobs:

  validate:
    name: Validate / Build
    runs-on: ubuntu-latest
    if: |
      contains(fromJSON('["master"]'), github.ref_name) ||
      contains(fromJSON('["dev","devfeatures","development"]'), github.ref_name)
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs['node-version'] }}

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Lint
        run: npm run lint --if-present

      - name: Build
        run: npm run build --if-present


  approval:
    name: Approval
    runs-on: ubuntu-latest
    needs: validate
    environment:
      name: ${{ github.ref_name == 'master' && 'Production' || 'auto-approve' }}
    steps:
      - run: | 
          echo "Branch: ${GITHUB_REF_NAME}"


  deploy:
    name: Deploy (Test or Prod)
    runs-on: ubuntu-latest
    needs: [validate, approval]
    if: |
      contains(fromJSON('["master"]'), github.ref_name) ||
      contains(fromJSON('["dev","devfeatures","development"]'), github.ref_name)
    env:
      FUNCTION_APP_NAME: ${{ github.ref_name == 'master' && inputs.prod_function_app_name || inputs.test_function_app_name }}
      PUBLISH_PROFILE: ${{ github.ref_name == 'master' && secrets.PUBLISH_PROFILE_PROD || secrets.PUBLISH_PROFILE_TEST }}
      WORKING_DIRECTORY: ${{ inputs.working_directory }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Package Function App
        run: |
          set -e
          cd "${WORKING_DIRECTORY}"
          zip -r ../functionapp.zip . -x "*.git*"
          ls -lh ../functionapp.zip

      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.FUNCTION_APP_NAME }}
          package: functionapp.zip
          publish-profile: ${{ env.PUBLISH_PROFILE }}